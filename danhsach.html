<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách Sinh viên - Quản lý</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .sidebar { background-color: #0c2e59; }
        .sidebar .nav-link, .sidebar .menu-toggle { color: #e2e8f0; }
        .sidebar .nav-link:hover, .sidebar .menu-toggle:hover, .sidebar .active-link { background-color: #1e40af; color: #ffffff; }
        .sidebar .submenu .nav-link { padding-left: 2.5rem; }
        .sidebar .submenu .active-sub-link { background-color: #1d4ed8; color: white; font-weight: 600; }
        .chevron-icon { transition: transform 0.3s; }
        .validation-error { color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem; }
        input.invalid { border-color: #ef4444; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: transform 0.3s ease, opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <aside id="sidebar" class="sidebar w-72 min-h-screen p-4 flex flex-col text-white">
            <div class="flex items-center pb-4 border-b border-gray-500">
                <img src="https://www.tlu.edu.vn/Portals/0/2014/Logo-WRU.png" class="h-12 w-12 object-contain" alt="Logo Trường">
                <div class="ml-3"><h1 class="text-sm font-bold">TRƯỜNG ĐẠI HỌC THỦY LỢI</h1><p class="text-xs text-gray-300">THUYLOI UNIVERSITY</p></div>
            </div>
            <nav id="main-nav" class="mt-6 flex-grow space-y-2">
                <a href="teacher.html" class="nav-link flex items-center py-2.5 px-4 rounded-lg"><i data-lucide="home" class="w-5 h-5"></i><span class="ml-4">Trang chủ</span></a>
                <div>
                    <button id="student-menu-toggle" class="menu-toggle flex items-center justify-between py-2.5 px-4 rounded-lg w-full text-left active-link">
                        <div class="flex items-center"><i data-lucide="users" class="w-5 h-5"></i><span class="ml-4">Quản lý sinh viên</span></div>
                        <i id="student-menu-chevron" data-lucide="chevron-down" class="w-4 h-4 chevron-icon rotate-180"></i>
                    </button>
                    <div id="student-submenu" class="submenu mt-1 space-y-1">
                        <a href="teacher.html#evaluation" class="nav-link flex items-center py-2.5 px-4 rounded-lg w-full"><i data-lucide="edit-3" class="w-5 h-5 ml-4"></i><span class="ml-4">Đánh giá sinh viên</span></a>
                        <a href="#" class="nav-link flex items-center py-2.5 px-4 rounded-lg w-full active-sub-link"><i data-lucide="contact" class="w-5 h-5 ml-4"></i><span class="ml-4">Danh sách sinh viên</span></a>
                    </div>
                </div>
                <a href="#" class="nav-link flex items-center py-2.5 px-4 rounded-lg"><i data-lucide="upload" class="w-5 h-5"></i><span class="ml-4">Tải lên tài liệu</span></a>
            </nav>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
             <header class="bg-white shadow-sm p-4 flex justify-between items-center">
                <div class="flex items-center">
                    <button id="back-button" class="text-gray-600 hover:text-gray-800 mr-4 hidden"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                    <div id="header-title" class="flex-1 text-xl font-semibold text-gray-800"></div>
                </div>
                <div class="flex items-center space-x-4"><div class="flex items-center cursor-pointer"><img src="https://placehold.co/40x40/E2E8F0/4A5568?text=NH" alt="Avatar" class="w-10 h-10 rounded-full border-2 border-gray-200"><div class="ml-3 hidden md:block"><p class="font-semibold text-sm text-gray-800">Nguyễn Thị Thu Hương</p><p class="text-xs text-gray-500">Giảng viên</p></div><i data-lucide="chevron-down" class="ml-2 w-4 h-4 text-gray-600"></i></div></div>
            </header>
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                <div id="page-student-list" class="page-content"><div class="bg-white p-4 rounded-lg shadow-sm"><div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4"><div class="relative w-full md:w-auto"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i><input type="text" placeholder="Tìm kiếm..." class="w-full md:w-64 pl-10 pr-4 py-2 border rounded-lg bg-gray-50"></div><button id="add-student-button" class="w-full md:w-auto px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center gap-2"><i data-lucide="plus"></i>Thêm mới</button></div><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-600"><thead class="bg-gray-100 text-xs text-gray-700 uppercase"><tr><th class="py-3 px-4">STT</th><th class="py-3 px-4">Họ và tên</th><th class="py-3 px-4">Ngày sinh</th><th class="py-3 px-4">Giới tính</th><th class="py-3 px-4">Địa chỉ</th><th class="py-3 px-4">CMND/CCCD</th><th class="py-3 px-4">Doanh nghiệp</th><th class="py-3 px-4">Vị trí</th><th class="py-3 px-4">Hành động</th></tr></thead><tbody id="student-list-table-body"></tbody></table></div></div></div>
                <div id="page-student-form" class="page-content hidden"><form id="student-form" class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-4">Thông tin sinh viên</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div><label for="name" class="text-sm font-medium text-gray-700">Họ và tên <span class="text-red-500">*</span></label><input type="text" id="name" name="name" class="w-full mt-1 p-2 border rounded-md"><span class="validation-error"></span></div><div><label for="dob" class="text-sm font-medium text-gray-700">Sinh ngày</label><input type="date" id="dob" name="dob" class="w-full mt-1 p-2 border rounded-md"></div><div><label for="address" class="text-sm font-medium text-gray-700">Địa chỉ</label><input type="text" id="address" name="address" class="w-full mt-1 p-2 border rounded-md"></div><div><label for="gender" class="text-sm font-medium text-gray-700">Giới tính</label><select id="gender" name="gender" class="w-full mt-1 p-2 border rounded-md bg-white"><option value="Nam">Nam</option><option value="Nữ">Nữ</option><option value="Khác">Khác</option></select></div><div><label for="phone" class="text-sm font-medium text-gray-700">Số điện thoại</label><input type="tel" id="phone" name="phone" class="w-full mt-1 p-2 border rounded-md"></div><div><label for="studentId" class="text-sm font-medium text-gray-700">Mã sinh viên <span class="text-red-500">*</span></label><input type="text" id="studentId" name="studentId" class="w-full mt-1 p-2 border rounded-md"><span class="validation-error"></span></div><div><label for="class" class="text-sm font-medium text-gray-700">Lớp học</label><input type="text" id="class" name="class" class="w-full mt-1 p-2 border rounded-md"></div><div><label for="course" class="text-sm font-medium text-gray-700">Khóa</label><input type="text" id="course" name="course" class="w-full mt-1 p-2 border rounded-md"></div><div><label for="faculty" class="text-sm font-medium text-gray-700">Khoa</label><input type="text" id="faculty" name="faculty" class="w-full mt-1 p-2 border rounded-md"></div><div><label for="major" class="text-sm font-medium text-gray-700">Ngành</label><input type="text" id="major" name="major" class="w-full mt-1 p-2 border rounded-md"></div><div><label for="company" class="text-sm font-medium text-gray-700">Công ty thực tập</label><input type="text" id="company" name="company" class="w-full mt-1 p-2 border rounded-md"></div><div><label for="position" class="text-sm font-medium text-gray-700">Vị trí thực tập</label><input type="text" id="position" name="position" class="w-full mt-1 p-2 border rounded-md"></div><div class="md:col-span-3"><label for="note" class="text-sm font-medium text-gray-700">Ghi chú</label><textarea id="note" name="note" rows="4" class="w-full mt-1 p-2 border rounded-md"></textarea></div></div><div class="flex justify-end gap-4 mt-6 pt-6 border-t"><button type="button" id="cancel-form-button" class="px-6 py-2.5 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition">Hủy</button><button type="submit" class="px-6 py-2.5 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">Lưu</button></div></form></div>
            </main>
        </div>
    </div>
    
    <div id="success-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0"><div class="modal-container bg-white w-full max-w-md rounded-lg shadow-lg p-6 relative opacity-0 transform -translate-y-10"><div class="flex justify-between items-center pb-3 border-b"><h3 class="text-lg font-bold text-green-600">Thao tác thành công</h3><button id="close-success-modal-button" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="py-4 flex items-center"><i data-lucide="check-circle" class="w-8 h-8 text-green-500 mr-3"></i><p>Dữ liệu đã được cập nhật thành công.</p></div><div class="flex justify-end pt-3 border-t"><button id="ok-success-modal-button" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">OK</button></div></div></div>
    <div id="delete-confirm-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0"><div class="modal-container bg-white w-full max-w-md rounded-lg shadow-lg p-6 relative opacity-0 transform -translate-y-10"><div class="flex justify-between items-center pb-3 border-b"><h3 class="text-lg font-bold text-gray-800">Xác nhận xóa</h3><button id="close-delete-modal-button" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="py-4 flex items-center"><i data-lucide="alert-triangle" class="w-8 h-8 text-yellow-500 mr-3"></i><p>Bạn có chắc chắn muốn xóa sinh viên này?</p></div><div class="flex justify-end pt-3 border-t gap-4"><button id="cancel-delete-button" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition">Hủy</button><button id="confirm-delete-button" class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition">Xóa</button></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // --- START: DATA SYNC LOGIC ---
            const STORAGE_KEY = 'studentMasterList';

            const loadStudentsFromStorage = () => {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    return JSON.parse(data);
                } else {
                    // If no data in storage, create some default data and save it
                    const defaultData = { 
                        "1686733200000": { name: "Ngô Minh Trung", dob: "2004-10-18", gender: "Nam", address: "Hải Dương", cccd: "030204007464", company: "SAM SUNG", position: "BACKEND WEB", studentId: "2251172533", class: "64KTPM3", course: "K64", faculty: "Khoa công nghệ thông tin", major: "Kỹ thuật phần mềm", phone: "0985584356", note: "", scores: { gd1: "8", gd2: "-", gd3: "-" }, attitude: "Tốt", status: "Đang thực hiện", comment: "Có thái độ tốt trong quá trình tham gia thực tập tại doanh nghiệp, hoàn thành tốt các công việc được giao" },
                        "1686733300000": { name: "Đoàn Thanh Tú", dob: "2004-10-16", gender: "Nam", address: "Hà Đông, Hà Nội", cccd: "00000000000", company: "VIETTEL", position: "FRONTEND WEB", studentId: "2251172540", class: "64KTPM3", course: "K64", faculty: "Khoa công nghệ thông tin", major: "Kỹ thuật phần mềm", phone: "0896117823", note: "", scores: { gd1: "9", gd2: "-", gd3: "-" }, attitude: "Tốt", status: "Đang thực hiện", comment: "" }
                    };
                    saveStudentsToStorage(defaultData);
                    return defaultData;
                }
            };

            const saveStudentsToStorage = (data) => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            };
            
            let studentDatabase = loadStudentsFromStorage();
            // --- END: DATA SYNC LOGIC ---


            let currentStudentId = null;
            let formMode = 'add'; 

            const pages = { "student-list": { title: 'Danh sách sinh viên thực tập' }, "student-form": { title: 'Thông tin sinh viên' } };
            
            const showPage = (pageId, studentId = null) => {
                currentStudentId = studentId;
                document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
                const targetPage = document.getElementById(`page-${pageId}`);
                if (targetPage) targetPage.classList.remove('hidden');
                
                document.getElementById('header-title').textContent = pages[pageId]?.title || '';
                document.getElementById('back-button').classList.toggle('hidden', pageId !== 'student-form');
                
                if (pageId === 'student-form') populateStudentForm();
            };

            const showModal = (modal) => { modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('.modal-container').classList.remove('opacity-0', '-translate-y-10'); }, 10); };
            const hideModal = (modal, cb) => { modal.classList.add('opacity-0'); modal.querySelector('.modal-container').classList.add('opacity-0', '-translate-y-10'); setTimeout(() => { modal.classList.add('hidden'); if(cb) cb(); }, 300); };
            
            const successModal = document.getElementById('success-modal');
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            
            document.getElementById('close-success-modal-button').addEventListener('click', () => hideModal(successModal));
            document.getElementById('ok-success-modal-button').addEventListener('click', () => hideModal(successModal));
            document.getElementById('close-delete-modal-button').addEventListener('click', () => hideModal(deleteConfirmModal));
            document.getElementById('cancel-delete-button').addEventListener('click', () => hideModal(deleteConfirmModal));

            const populateStudentListTable = () => {
                const tableBody = document.getElementById('student-list-table-body');
                // Use Object.values to get an array of students for easier mapping
                const studentArray = Object.values(studentDatabase);
                if (studentArray.length === 0) {
                     tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-gray-500">Không có sinh viên nào trong danh sách.</td></tr>`;
                     return;
                }
                tableBody.innerHTML = Object.keys(studentDatabase).map((id, index) => {
                    const s = studentDatabase[id];
                    return `<tr data-student-id="${id}" class="bg-white border-b hover:bg-gray-50"><td class="py-3 px-4">${index+1}</td><td class="py-3 px-4 font-medium">${s.name}</td><td>${s.dob || ''}</td><td>${s.gender || ''}</td><td>${s.address || ''}</td><td>${s.cccd || ''}</td><td>${s.company || ''}</td><td>${s.position || ''}</td><td class="py-3 px-4 flex gap-2"><button class="text-green-600 hover:text-green-800 edit-btn-list"><i data-lucide="edit"></i></button><button class="text-red-600 hover:text-red-800 delete-btn-list"><i data-lucide="trash-2"></i></button></td></tr>`;
                }).join('');
                lucide.createIcons();
            };

            const populateStudentForm = () => {
                const form = document.getElementById('student-form');
                form.reset();
                document.querySelectorAll('.validation-error').forEach(el => el.textContent = '');
                document.querySelectorAll('input.invalid').forEach(el => el.classList.remove('invalid'));
                if (formMode === 'edit' && currentStudentId && studentDatabase[currentStudentId]) {
                    const student = studentDatabase[currentStudentId];
                    for (const key in student) if (form.elements[key]) form.elements[key].value = student[key];
                }
            };

            const validateField = (field) => {
                const errorEl = field.nextElementSibling;
                errorEl.textContent = '';
                field.classList.remove('invalid');
                if (field.value.trim() === '') {
                    errorEl.textContent = 'Trường này không được để trống.';
                    field.classList.add('invalid');
                    return false;
                }
                return true;
            };

            document.getElementById('student-menu-toggle').addEventListener('click', () => { document.getElementById('student-submenu').classList.toggle('hidden'); document.getElementById('student-menu-chevron').classList.toggle('rotate-180'); });
            document.getElementById('back-button').addEventListener('click', () => showPage('student-list'));
            document.getElementById('add-student-button').addEventListener('click', () => { formMode = 'add'; showPage('student-form'); });
            document.getElementById('cancel-form-button').addEventListener('click', () => showPage('student-list'));
            
            document.getElementById('student-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (!validateField(document.getElementById('name')) || !validateField(document.getElementById('studentId'))) return;
                
                const formData = new FormData(e.target);
                const newStudentData = Object.fromEntries(formData.entries());
                const idToSave = formMode === 'add' ? Date.now().toString() : currentStudentId;

                // For new students, add default evaluation fields
                if (formMode === 'add') {
                    newStudentData.scores = { gd1: "-", gd2: "-", gd3: "-" };
                    newStudentData.attitude = "";
                    newStudentData.status = "Chưa thực hiện";
                    newStudentData.comment = "";
                }
                
                studentDatabase[idToSave] = { ...(studentDatabase[idToSave] || {}), ...newStudentData };
                
                // MODIFIED: Save to storage
                saveStudentsToStorage(studentDatabase);

                populateStudentListTable();
                showPage('student-list');
                showModal(successModal);
            });

            document.getElementById('student-list-table-body').addEventListener('click', (e) => {
                 const row = e.target.closest('tr'); if (!row) return;
                 const studentId = row.dataset.studentId;
                 if(e.target.closest('.edit-btn-list')) { e.preventDefault(); formMode = 'edit'; showPage('student-form', studentId); }
                 else if(e.target.closest('.delete-btn-list')) { e.preventDefault(); currentStudentId = studentId; showModal(deleteConfirmModal); }
            });

            document.getElementById('confirm-delete-button').addEventListener('click', () => {
                if (currentStudentId) { 
                    delete studentDatabase[currentStudentId];
                    // MODIFIED: Save to storage
                    saveStudentsToStorage(studentDatabase);
                    populateStudentListTable(); 
                    hideModal(deleteConfirmModal); 
                }
            });
            
            populateStudentListTable();
            showPage('student-list');
        });
    </script>
</body>
</html>